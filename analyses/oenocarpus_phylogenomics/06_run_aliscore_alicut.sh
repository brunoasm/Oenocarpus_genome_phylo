#!/bin/bash
# 06_run_aliscore_alicut.sh
# Trims alignments using Aliscore/ALICUT to remove randomly similar sequences (RSS)
# Uses Monte Carlo resampling to identify ambiguously aligned regions
# Optimized for local machine
# Generated by Claude phylo_from_buscos skill

set -e

echo "=========================================="
echo "STEP 6: Alignment Trimming (Aliscore/ALICUT)"
echo "=========================================="
echo ""

# Activate conda environment
source "$(conda info --base)/etc/profile.d/conda.sh"
conda activate phylo

# Check if aligned sequences exist
if [ ! -d "single_copy_orthologs/aligned_aa" ]; then
    echo "ERROR: single_copy_orthologs/aligned_aa directory not found!"
    echo "Please run 05_run_mafft.sh first."
    exit 1
fi

# Check if Aliscore/ALICUT scripts exist
if [ ! -f "scripts/Aliscore.02.2.pl" ] || [ ! -f "scripts/ALICUT_V2.31.pl" ]; then
    echo "ERROR: Aliscore/ALICUT scripts not found!"
    echo "Please run setup_phylo_env.sh first."
    exit 1
fi

echo "Using Aliscore/ALICUT batch processing with parallelization"
echo "Parameters: -N (treat gaps as ambiguous, recommended for amino acids)"
echo "Parallel jobs: 20"
echo ""

# Run batch processing script with 20 parallel jobs
bash scripts/run_aliscore_alicut_batch.sh \
    single_copy_orthologs/aligned_aa/ \
    -N \
    -j 20 \
    -o single_copy_orthologs/trimmed_aa

echo ""
echo "=========================================="
echo "STEP 6 Complete!"
echo "=========================================="
echo ""
echo "Trimmed alignments are in: single_copy_orthologs/trimmed_aa/"
echo ""

# Display overall trimming statistics if summary exists
if [ -f "single_copy_orthologs/trimmed_aa/trimming_summary.txt" ]; then
    echo "Overall Trimming Statistics:"
    awk 'NR>1 {
        total_orig += $2;
        total_trim += $3;
        total_removed += $4;
        count++
    }
    END {
        if (count > 0) {
            avg_removed = (total_removed / total_orig) * 100;
            printf "  Total positions before: %d\n", total_orig;
            printf "  Total positions after:  %d\n", total_trim;
            printf "  Total removed:          %d (%.2f%%)\n", total_removed, avg_removed;
            printf "  Number of loci:         %d\n", count;
        }
    }' single_copy_orthologs/trimmed_aa/trimming_summary.txt
    echo ""
    echo "Full summary available in: single_copy_orthologs/trimmed_aa/trimming_summary.txt"
    echo ""
fi

# Count trimmed alignments
num_trimmed=$(ls single_copy_orthologs/trimmed_aa/*.fas 2>/dev/null | wc -l)
echo "Number of trimmed alignments: ${num_trimmed}"
echo ""
echo "Quality Control Guidelines:"
echo "  - Well-aligned loci: 5-15% removed"
echo "  - Moderately aligned: 15-30% removed"
echo "  - Poorly aligned: >30% removed (consider excluding)"
echo ""
echo "Next step: Run 07_concatenate.sh to build supermatrix"
echo ""
